<script>

const url = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRHurVp3MKLNA0mvWeNfN4IH8O05dCo-kc52FtiT7f_n0cpZum9mQ1VCLNObhkm0rpkgzwFPJPrRwY_/pub?gid=0&single=true&output=csv";

// ENTER untuk cari
document.getElementById("searchInput").addEventListener("keypress", function(e){
  if(e.key === "Enter") searchData();
});

// Normalisasi string (anti spasi & beda huruf)
function normalize(str){
  return str?.toString().trim().toLowerCase();
}

async function searchData(){

const keyword = normalize(document.getElementById("searchInput").value);

if(keyword === ""){
  alert("Masukkan Nomor Permintaan terlebih dahulu");
  return;
}

document.getElementById("result").innerHTML = "<div class='loading'>Sedang memuat data...</div>";

try{

const response = await fetch(url);
const csv = await response.text();

const parsed = Papa.parse(csv, { 
  header: true,
  skipEmptyLines: true 
});

const rows = parsed.data;

// ðŸ”¥ NORMALISASI HEADER OTOMATIS
const cleanRows = rows.map(row => {
  const newRow = {};
  Object.keys(row).forEach(key => {
    const cleanKey = normalize(key);
    newRow[cleanKey] = row[key];
  });
  return newRow;
});

let found = false;
let html = "";

for(let row of cleanRows){

  const nomorPermintaan = normalize(row["nomor permintaan"]);

  if(nomorPermintaan === keyword){

    found = true;

    html = `
    <div class="table-wrapper">
    <table>
      <tr>
        <th>NAMA PELANGGAN</th>
        <th>NOMOR PERMINTAAN</th>
        <th>JUMLAH SAMPEL</th>
        <th>JENIS PENGUJIAN</th>
        <th>TGL BAYAR</th>
        <th>PENYIAPAN</th>
        <th>PENGUJIAN</th>
        <th>SUBKONTRAK</th>
        <th>PEMBUATAN LHP</th>
        <th>LHP TERBIT</th>
        <th>TGL TERBIT</th>
        <th>ESTIMASI</th>
        <th>KETERANGAN</th>
      </tr>
      <tr>
        <td>${row["nama pelanggan"] || "-"}</td>
        <td>${row["nomor permintaan"] || "-"}</td>
        <td>${row["jumlah sampel"] || "-"}</td>
        <td>${row["jenis pengujian"] || "-"}</td>
        <td>${row["tgl bayar"] || "-"}</td>
        <td>${row["penyiapan"] || "-"}</td>
        <td>${row["pengujian"] || "-"}</td>
        <td>${row["subkontrak"] || "-"}</td>
        <td>${row["pembuatan lhp"] || "-"}</td>
        <td>${row["lhp terbit"] || "-"}</td>
        <td>${row["tgl terbit"] || "-"}</td>
        <td>${row["estimasi"] || "-"}</td>
        <td>${row["keterangan"] || "-"}</td>
      </tr>
    </table>
    </div>
    `;
    break;
  }
}

if(!found){
  html = "<div class='notfound'>Data tidak ditemukan</div>";
}

document.getElementById("result").innerHTML = html;

}catch(error){
  document.getElementById("result").innerHTML =
  "<div class='notfound'>Terjadi kesalahan mengambil data</div>";
}

}

</script>
