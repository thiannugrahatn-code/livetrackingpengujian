<script>

const url = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRHurVp3MKLNA0mvWeNfN4IH8O05dCo-kc52FtiT7f_n0cpZum9mQ1VCLNObhkm0rpkgzwFPJPrRwY_/pub?gid=0&single=true&output=csv";

document.getElementById("searchInput").addEventListener("keypress", function(e){
  if(e.key === "Enter") searchData();
});

function normalize(str){
  return String(str || "").trim().toLowerCase();
}

async function searchData(){

const keyword = normalize(document.getElementById("searchInput").value);

if(!keyword){
  alert("Masukkan Nomor Permintaan terlebih dahulu");
  return;
}

document.getElementById("result").innerHTML = "<div class='loading'>Sedang memuat data...</div>";

try{

const response = await fetch(url);
const csv = await response.text();

const parsed = Papa.parse(csv, { 
  header: false,
  skipEmptyLines: true 
});

const rows = parsed.data;

if(rows.length < 2){
  document.getElementById("result").innerHTML =
  "<div class='notfound'>Sheet kosong atau tidak valid</div>";
  return;
}

// ðŸ”¥ Ambil header dari baris pertama
const headers = rows[0].map(h => normalize(h));

// ðŸ”¥ Cari index kolom Nomor Permintaan
const nomorIndex = headers.findIndex(h => 
  h.replace(/\s/g,'') === "nomorpermintaan"
);

if(nomorIndex === -1){
  document.getElementById("result").innerHTML =
  "<div class='notfound'>Kolom Nomor Permintaan tidak ditemukan</div>";
  console.log("HEADER TERBACA:", headers);
  return;
}

let found = false;
let html = "";

// ðŸ”¥ Loop mulai dari baris ke-2 (index 1)
for(let i = 1; i < rows.length; i++){

  const row = rows[i];
  const nomor = normalize(row[nomorIndex]);

  if(nomor.includes(keyword)){

    found = true;

    html = `
    <div class="table-wrapper">
    <table>
      <tr>
        ${rows[0].map(h => `<th>${h}</th>`).join("")}
      </tr>
      <tr>
        ${row.map(cell => `<td>${cell || "-"}</td>`).join("")}
      </tr>
    </table>
    </div>
    `;
    break;
  }
}

if(!found){
  html = "<div class='notfound'>Data tidak ditemukan</div>";
}

document.getElementById("result").innerHTML = html;

}catch(error){
  console.error(error);
  document.getElementById("result").innerHTML =
  "<div class='notfound'>Gagal mengambil data</div>";
}

}

</script>
